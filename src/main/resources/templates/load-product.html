<div class="card" xmlns:th="http://www.thymeleaf.org">
    <div class="card-body">
        <div class="d-flex mb-3">
            <h3 class="flex-grow-1 mt-0 header-title">
                Danh sách sản phẩm
            </h3>
            <a class="btn btn-primary" href="#modal-input-product"
               data-toggle="modal" data-animation="bounce"
               onclick="getProduct(this)" data-id="-1">
                Thêm sản phẩm
            </a>
        </div>
        <div class="table-responsive">
            <table class="table mb-0 table-centered">
                <thead>
                <tr>
                    <th>#</th>
                    <th>Tên</th>
                    <th>Loại</th>
                    <th>Thương hiệu</th>
                    <th>Giá</th>
                    <th>Giá giảm</th>
                    <th>Tồn kho</th>
                    <th>Đánh giá</th>
                    <th>Trạng thái</th>
                    <th></th>
                </tr>
                </thead>
                <tbody>
                <th:block th:each="product, theCount: ${lstProduct}" th:object="${product}">
                    <tr>
                        <td th:text="${theCount.index+1}">#</td>
                        <td th:text="*{name}"></td>
                        <td th:text="*{nameCategory}"></td>
                        <td th:text="*{nameBrand}"></td>
                        <td th:text="*{#numbers.formatDecimal(price, 0, 'COMMA', 0, 'POINT') + '₫'}"></td>
                        <td th:text="*{#numbers.formatDecimal(priceSale, 0, 'COMMA', 0, 'POINT') + '₫'}"></td>
                        <td th:text="*{quantity}"></td>
                        <td>
                            <div class="ratings">
                                <div class="ratings-val" th:style="'width: '+*{pointReview}+'%;'"></div>
                                <!-- End .ratings-val -->
                            </div><!-- End .ratings -->
                        </td>
                        <td>Trạng thái</td>
                        <td>
                            <div class="dropdown d-inline-block float-right">
                                <a class="nav-link dropdown-toggle arrow-none" id="dLabel4"
                                   data-toggle="dropdown" href="#" role="button"
                                   aria-haspopup="false" aria-expanded="false">
                                    <i class="fas fa-ellipsis-v font-20 text-muted"></i>
                                </a>
                                <div class="dropdown-menu dropdown-menu-right" aria-labelledby="dLabel4">
                                    <a class="dropdown-item" href="#modal-input-product"
                                       data-toggle="modal" data-animation="bounce"
                                       onclick="getProduct(this)" th:data-id="*{id}">
                                        Chỉnh sửa
                                    </a>
                                    <a href="#" onclick="changeStatusProduct(this)" th:if="*{status}" class="dropdown-item"
                                       data-method="status" data-method-data="false" th:data-id="*{id}">
                                        Ngừng kinh doanh
                                    </a>
                                </div>
                            </div>
                        </td>
                    </tr>
                </th:block>
                </tbody>
            </table>
            <!--end /table-->
        </div>
        <!--end /tableresponsive-->
        <nav th:if="${totalPage > 1}" aria-label="..." class="pagination custom-pagination float-right">
            <ul class="list-unstyled">
                <li th:unless="${page == 0}" class="list-inline-item">
                    <a class="page-link bg-primary text-light" style="cursor: pointer" onclick="clickPage(this)"
                       th:data-index="${page - 1}"
                       aria-label="Previous">
                        <span aria-hidden="true">«</span>
                        <span class="sr-only">Previous</span>
                        <div class="ripple-container"></div>
                    </a>
                </li>
                <li th:if="${page - 2 > 0}" class="list-inline-item">
                    <a class="page-link" style="cursor: pointer" tabindex="-1" onclick="clickPage(this)"
                       th:data-index="${0}">1</a>
                </li>
                <li th:if="${page - 2 > 1}" class="list-inline-item">
                    <a class="page-link" style="cursor: pointer" tabindex="-1">...</a>
                </li>
                <th:block th:each="index, theCount: ${#numbers.sequence(0, totalPage - 1)}">
                    <th:block th:if="${index < page + 2 && index >= page - 2}">
                        <li th:if="${index == page}" class="list-inline-item">
                            <a class="page-link bg-dark text-white" style="cursor: pointer" tabindex="-1"
                               th:text="${index + 1}"></a>
                        </li>
                        <li th:unless="${index == page}" class="list-inline-item">
                            <a class="page-link" style="cursor: pointer" tabindex="-1" onclick="clickPage(this)"
                               th:data-index="${index}"
                               th:text="${index + 1}"></a>
                        </li>
                    </th:block>
                </th:block>
                <li th:if="${totalPage - 3 > page}" class="list-inline-item">
                    <a class="page-link" style="cursor: pointer" tabindex="-1">...</a>
                </li>
                <li th:if="${totalPage - 2 > page}" class="list-inline-item">
                    <a class="page-link" style="cursor: pointer" tabindex="-1" onclick="clickPage(this)"
                       th:data-index="${totalPage - 1}"
                       th:text="${totalPage}"></a>
                </li>
                <li th:unless="${page + 1 == totalPage}" class="list-inline-item">
                    <a class="page-link bg-primary text-light" onclick="clickPage(this)" style="cursor: pointer"
                       th:data-index="${page + 1}"
                       aria-label="Next">
                        <span aria-hidden="true">»</span>
                        <span class="sr-only">Next</span>
                    </a>
                </li>
            </ul>
            <!--end pagination-->
        </nav>
    </div>
    <!--end card-body-->
</div>
<!--end card-->
<!--    MODAL-->
<div class="modal fade" id="modal-input-product" tabindex="-1" role="dialog"
     aria-labelledby="myLargeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title mt-0"> Nhập thông tin sản phẩm </h5>
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
            </div>
            <div class="modal-body">
                <div id="smart_wizard">
                    <ul>
                        <li><a href="#step-1">Nhập<br><small>Nhập thông tin sản phẩm</small></a></li>
                        <li><a href="#step-2">Mô tả<br><small>Mô tả chi tiết sản phẩm</small></a></li>
                        <li><a href="#step-3">Tải ảnh<br><small>Tải lên ảnh sản phẩm</small></a></li>
                    </ul>
                    <div class="p-3 sw-default-content mb-3">
                        <div id="step-1" class="">
                            <form id="form-input-product">
                                <input type="hidden" name="id"/>
                                <div class="form-group row">
                                    <strong class="col-sm-2 col-form-label text-right">
                                        Tên sản phẩm
                                    </strong>
                                    <div class="col-sm-10">
                                        <input class="form-control" type="text" placeholder="Nhập tên sản phẩm"
                                               name="name" maxlength="50" id="name-product"
                                               onchange="changeNameProductAndChangePathProduct()">
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <strong class="col-sm-2 col-form-label text-right">
                                        Đường dẫn
                                    </strong>
                                    <div class="col-sm-10">
                                        <input class="form-control" type="text" placeholder="Nhập đường dẫn"
                                               name="path" maxlength="32" id="path-product"
                                               onchange="changePathUrlProduct()">
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <strong class="col-sm-2 col-form-label text-right">
                                        Thương hiệu
                                    </strong>
                                    <div class="col-sm-10">
                                        <select class="select2 form-control custom-select" name="idBrand"
                                                id="idBrand" style="width: 100%; height:36px;">
                                            <th:block th:each="brand:${lstBrands}" th:object="${brand}">
                                                <option th:value="*{id}" th:text="*{name}"></option>
                                            </th:block>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <strong class="col-sm-2 col-form-label text-right">
                                        Loại sản phẩm
                                    </strong>
                                    <div class="col-sm-10">
                                        <select class="select2 form-control custom-select" name="idCategory"
                                                id="idCategory" style="width: 100%; height:36px;">
                                            <th:block th:each="category:${lstCategories}" th:object="${category}">
                                                <option th:value="*{id}" th:text="*{name}"></option>
                                            </th:block>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <strong class="col-sm-2 col-form-label text-right">
                                        Giá bán ra
                                    </strong>
                                    <div class="col-sm-10">
                                        <input class="form-control" type="text" placeholder="Nhập giá bán ra"
                                               name="price" maxlength="32">
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <strong class="col-sm-2 col-form-label text-right">
                                        Giá giảm
                                    </strong>
                                    <div class="col-sm-10">
                                        <input class="form-control" type="text" placeholder="Nhập giá giảm"
                                               name="priceSale" maxlength="32">
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <strong class="col-sm-2 col-form-label text-right">
                                        Số lượng
                                    </strong>
                                    <div class="col-sm-10">
                                        <input class="form-control" type="text" placeholder="Nhập số lượng"
                                               name="quantity" maxlength="32">
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <strong class="col-sm-2 col-form-label text-right">
                                        Màu sắc
                                    </strong>
                                    <div class="col-sm-10">
                                        <input class="form-control" type="text" placeholder="Nhập màu sắc"
                                               name="color" maxlength="32">
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <strong class="col-sm-2 col-form-label text-right">
                                        Loại chi tiết
                                    </strong>
                                    <div class="col-sm-10">
                                        <input class="form-control" type="text" placeholder="Nhập loại chi tiết"
                                               name="categoryDetails" maxlength="32">
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <strong class="col-sm-2 col-form-label text-right">
                                        Vị trí
                                    </strong>
                                    <div class="col-sm-10">
                                        <input class="form-control" type="text"
                                               placeholder="Nhập vị trí đặt sản phẩm"
                                               name="location" maxlength="32">
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <strong class="col-sm-2 col-form-label text-right">
                                        Hướng dẫn sử dụng
                                    </strong>
                                    <div class="col-sm-10">
                                        <input type="file" id="input-file-now-custom-2" name="pathUserManual"
                                               class="file-user-manual dropify"
                                               accept="application/msword, application/vnd.ms-excel, application/vnd.ms-powerpoint, text/plain, application/pdf"
                                               onchange="onChangeFile(this)" data-oldfile="" data-height="200">
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div id="step-2" class="">
                            <form id="form-description-product" class="row">
                                <div class="form-group row">
                                    <strong class="col-sm-2 col-form-label text-right">
                                        Mô tả
                                    </strong>
                                    <div class="col-sm-10">
                                            <textarea class="form-control" name="description" maxlength="255" rows="3"
                                                      id="description"  placeholder="Nhập mô tả"></textarea>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div id="step-3" class="">
                            <form id="form-images-product" class="row">

                            </form>
                        </div>
                    </div>
                    <!--end /div-->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary waves-effect" data-dismiss="modal">Huỷ bỏ
                    </button>
                    <button type="button" onclick="saveProduct()" class="btn btn-primary waves-effect waves-light">
                        Lưu lại
                    </button>
                </div>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<script th:src="@{/ckeditor/ckeditor.js}"></script>

<script>
    $(document).ready(function() {
        CKEDITOR.replace("description")
    })
    for (let i = 0; i < 12; i++) {
        $('#form-images-product').append('<div class="col-lg-4">' +
            '<input type="file" class="dropify" data-height="150" data-index="' + i + '" accept="image/png, image/gif, image/jpeg" onchange="onChangeImage(this)">' +
            '</div>').html()
    }
</script>

<script th:src="@{/js/daterangepicker.js}"></script>
<script th:src="@{/js/tempusdominus-bootstrap-4.js}"></script>
<script th:src="@{/js/bootstrap-material-datetimepicker.js}"></script>
<script th:src="@{/js/jquery-clockpicker.min.js}"></script>
<script th:src="@{/js/jquery-asColor.js}"></script>
<script th:src="@{/js/jquery-asGradient.js}"></script>
<script th:src="@{/js/jquery-asColorPicker.min.js}"></script>
<script th:src="@{/js/select2.min.js}"></script>
<script th:src="@{/js/bootstrap-colorpicker.min.js}"></script>
<script th:src="@{/js/bootstrap-datepicker.min.js}"></script>
<script th:src="@{/js/bootstrap-maxlength.min.js}"></script>
<script th:src="@{/js/jquery.bootstrap-touchspin.min.js}"></script>
<script th:src="@{/js/jquery.clock-img.init.js}"></script>
<script th:src="@{/js/jquery.forms-advanced.js}"></script>
<!--    UPLOAD-->
<script th:src="@{/js/dropify.min.js}"></script>
<script th:src="@{/js/jquery.form-upload.init.js}"></script>

<script th:src="@{/js/jquery.repeater.min.js}"></script>
<script th:src="@{/js/jquery.smartWizard.min.js}"></script>
<script th:src="@{/js/jquery.form-wizard.init.js}"></script>

<script>

    let objFileImage = {
        data: [],
        nameFile: [],
    }

    let objFileUseManual = {
        data: null,
        nameFile: null,
    }

    async function onChangeImage(e) {
        if (!checkImage(e.files[0].name, 'File ')) return;
        let index = e.dataset.index
        // objFileUseManual.targetFile = e
        // objFileImage.targetFile[index] = e
        objFileImage.nameFile[index] = getNameTime() + e.files[0].name
        let data = await toBase64(e.files[0])
        objFileImage.data[index] = data
    }

    function changeNameProductAndChangePathProduct() {
        $('#path-product').val(strToPath($('#name-product').val()))
    }

    function changePathUrlProduct() {
        let pathUrl = strToPath($('#path-product').val())
        $('#path-product').val(pathUrl)
    }

    async function onChangeFile(e) {
        objFileUseManual.nameFile = getNameTime() + e.files[0].name
        let data = await toBase64(e.files[0])
        objFileUseManual.data = data
    }

    async function saveProduct() {
        let form = $("#form-input-product").serializeArray()
        let obj = {};
        for (let i = 0; i < form.length; i++) {
            let name = form[i].name;
            obj[name] = form[i].value;
        }
        console.log(obj)
        if (!checkFileDoc(objFileUseManual.nameFile, 'File hướng dẫn sử dụng')) {
            return
        } else {
            obj['pathUserManual'] = objFileUseManual.nameFile
        }
        for (let i = 0; i < objFileImage.nameFile.length; i++) {
            if (objFileImage.nameFile[i] !== null
                && objFileImage.nameFile[i] !== undefined
                && objFileImage.nameFile[i] !== '') {
                if (!checkImage(objFileImage.nameFile[i], 'Hình ảnh số ' + (i + 1))) {
                    objFileImage.nameFile[i] = null;
                    return;
                }
            }
        }
        obj.images = objFileImage.nameFile
        swal('Đang lưu...', 'Vui lòng đợi', 'success')
        if (objFileUseManual.data !== null && objFileUseManual.data !== undefined) {
            let data = objFileUseManual.data + '';
            let base = data.substring(data.indexOf(",") + 1, data.length)
            await fetch('https://api.github.com/repos/ngocnqph12806/Repo_File/contents/' + objFileUseManual.nameFile, {
                method: 'PUT',
                headers: {
                    "Authorization": "Bearer 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",
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    "message": "uploading a file in date: " + getNameTime(),
                    "content": base
                }),
            })
                .then(response => response.json())
                .then(out => {
                    console.log("up thành công");
                })
                .catch((error) => {
                    console.error('Error:', error);
                });
            objFileUseManual.data = null
        }
        for (let i = 0; i < objFileImage.nameFile.length; i++) {
            if (objFileImage.nameFile[i] !== null
                && objFileImage.nameFile[i] !== undefined
                && objFileImage.nameFile[i] !== '') {
                if (!checkImage(objFileImage.nameFile[i], 'Hình ảnh số ' + (i + 1))) {
                    objFileImage.nameFile[i] = null;
                    return;
                } else if (objFileImage.data[i] !== null && objFileImage.data[i] !== undefined
                    && objFileImage.nameFile[i] !== null && objFileImage.nameFile[i] !== undefined) {
                    let data = objFileImage.data[i] + '';
                    let base = data.substring(data.indexOf(",") + 1, data.length)
                    await fetch('https://api.github.com/repos/ngocnqph12806/Repo_File/contents/' + objFileImage.nameFile[i], {
                        method: 'PUT',
                        headers: {
                            "Authorization": "Bearer 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",
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            "message": "uploading a file in date: " + getNameTime(),
                            "content": base
                        }),
                    })
                        .then(response => response.json())
                        .then(out => {
                            console.log("up thành công");
                        })
                        .catch((error) => {
                            console.error('Error:', error);
                        });
                    objFileImage.data[i] = null;
                }
            }
        }
        if (obj.id !== null && obj.id !== undefined && obj.id !== '') {
            saveWithAPI(JSON.stringify(obj), '/api/product/' + obj.id, 'PUT', '/admin/load/product', 0, 5)
        } else {
            saveWithAPI(JSON.stringify(obj), '/api/product', 'POST', '/admin/load/product', 0, 5)
        }
    }

    async function saveFile() {
        if (objFileUseManual.targetFile !== null && objFileUseManual.targetFile !== undefined) {
            await writeFileGitHub(objFileUseManual.targetFile, objFileUseManual.nameFile)
            objFileUseManual.targetFile = null
        }
        for (let i = 0; i < objFileImage.nameFile.length; i++) {
            if (objFileImage.nameFile[i] !== null
                && objFileImage.nameFile[i] !== undefined
                && objFileImage.nameFile[i] !== '') {
                if (!checkImage(objFileImage.nameFile[i], 'Hình ảnh số ' + (i + 1))) {
                    objFileImage.nameFile[i] = null;
                    return false;
                } else if (objFileImage.targetFile[i] !== null && objFileImage.targetFile[i] !== undefined
                    && objFileImage.nameFile[i] !== null && objFileImage.nameFile[i] !== undefined) {
                    await writeFileGitHub(objFileImage.targetFile[i], objFileImage.nameFile[i])
                    objFileImage.nameFile[i] = null;
                }
            }
        }
        return true;
    }

    function getProduct(e) {
        $.ajax({
            url: '/api/product/' + e.dataset.id + '?modal',
            type: 'GET',
            contentType: 'application/json',
            success: function (response) {
                appendFormdata('form-input-product', response, objFileUseManual)
            }
        });
    }

    function changeStatusProduct(e) {
        let data = e.dataset.methodData;
        let id = e.dataset.id
        if (e.dataset.method === 'status') {
            $.ajax({
                url: '/api/product/' + id + '/status',
                type: 'PUT',
                data: {"status": (data === 'true')},
                beforeSend: function (xhr) {
                    xhr.setRequestHeader("Authorization", "Bearer " + getSession('access_token'));
                },
                success: function (response) {
                    swal("Thành công", "Thay đổi trạng thái sản phẩm thành công", "success")
                    loadData('/admin/load/product', 0, 5)
                },
                error: function (data) {
                    swal("Thất bại", data.responseJSON.message, "warning")
                }
            });
        }
    }
</script>