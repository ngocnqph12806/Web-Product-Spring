<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="/layout/admin/index"
>
<head>
    <title layout:fragment="title">Dasboard - Quản lý hàng hoá</title>
</head>
<body>
<div layout:fragment="content-admin">
    <div class="card">
        <div class="card-body">
            <div class="d-flex mb-3">
                <h3 class="flex-grow-1 mt-0 header-title">
                    Danh sách sản phẩm
                </h3>
                <a class="btn btn-primary" href="#modal-input-product"
                   data-toggle="modal" data-animation="bounce"
                   onclick="getProduct(this)" data-id="-1">
                    Thêm sản phẩm
                </a>
            </div>
            <div class="table-responsive">
                <table class="table mb-0 table-centered">
                    <thead>
                    <tr>
                        <th>#</th>
                        <th>Tên</th>
                        <th>Loại</th>
                        <th>Thương hiệu</th>
                        <th>Giá</th>
                        <th>Giá giảm</th>
                        <th>Đánh giá</th>
                        <th>Trạng thái</th>
                        <th></th>
                    </tr>
                    </thead>
                    <tbody>
                    <th:block th:each="product, theCount: ${lstProduct}" th:object="${product}">
                        <tr>
                            <td th:text="${theCount.index+1}">#</td>
                            <td th:text="*{name}"></td>
                            <td th:text="*{nameCategory}"></td>
                            <td th:text="*{nameBrand}"></td>
                            <td th:text="*{#numbers.formatDecimal(price, 0, 'COMMA', 0, 'POINT') + '₫'}"></td>
                            <td th:text="*{#numbers.formatDecimal(priceSale, 0, 'COMMA', 0, 'POINT') + '₫'}"></td>
                            <td>
                                <div class="ratings">
                                    <div class="ratings-val" th:style="'width: '+*{pointReview}+'%;'"></div>
                                    <!-- End .ratings-val -->
                                </div><!-- End .ratings -->
                            </td>
                            <td>Trạng thái</td>
                            <td>
                                <div class="dropdown d-inline-block float-right">
                                    <a class="nav-link dropdown-toggle arrow-none" id="dLabel4"
                                       data-toggle="dropdown" href="#" role="button"
                                       aria-haspopup="false" aria-expanded="false">
                                        <i class="fas fa-ellipsis-v font-20 text-muted"></i>
                                    </a>
                                    <div class="dropdown-menu dropdown-menu-right" aria-labelledby="dLabel4">
                                        <a class="dropdown-item" href="#modal-input-product"
                                           data-toggle="modal" data-animation="bounce"
                                           onclick="getProduct(this)" th:data-id="*{id}">
                                            Chỉnh sửa
                                        </a>
                                        <a href="#" onclick="changeStatus(this)" th:if="*{status}" class="dropdown-item"
                                           data-method="status" data-method-data="false" th:data-id="*{id}">
                                            Ngừng kinh doanh
                                        </a>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    </th:block>
                    </tbody>
                </table>
                <!--end /table-->
            </div>
            <!--end /tableresponsive-->
        </div>
        <!--end card-body-->
    </div>
    <!--end card-->
    <!--    MODAL-->
    <div class="modal fade" id="modal-input-product" tabindex="-1" role="dialog"
         aria-labelledby="myLargeModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title mt-0"> Nhập thông tin sản phẩm </h5>
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                </div>
                <div class="modal-body">
                    <div id="smart_wizard">
                        <ul>
                            <li><a href="#step-1">Nhập<br><small>Nhập thông tin sản phẩm</small></a></li>
                            <li><a href="#step-2">Tải ảnh<br><small>Tải lên ảnh sản phẩm</small></a></li>
                        </ul>
                        <div class="p-3 sw-default-content mb-3">
                            <div id="step-1" class="">
                                <form id="form-input-product">
                                    <input type="hidden" name="id"/>
                                    <div class="form-group row">
                                        <strong class="col-sm-2 col-form-label text-right">
                                            Tên sản phẩm
                                        </strong>
                                        <div class="col-sm-10">
                                            <input class="form-control" type="text" placeholder="Nhập tên sản phẩm"
                                                   name="name" maxlength="50" id="name">
                                        </div>
                                    </div>
                                    <div class="form-group row">
                                        <strong class="col-sm-2 col-form-label text-right">
                                            Đường dẫn
                                        </strong>
                                        <div class="col-sm-10">
                                            <input class="form-control" type="text" placeholder="Nhập đường dẫn"
                                                   name="path" maxlength="32" id="path">
                                        </div>
                                    </div>
                                    <div class="form-group row">
                                        <strong class="col-sm-2 col-form-label text-right">
                                            Thương hiệu
                                        </strong>
                                        <div class="col-sm-10">
                                            <select class="select2 form-control custom-select" name="idBrand"
                                                    id="idBrand" style="width: 100%; height:36px;">
                                                <th:block th:each="brand:${lstBrands}" th:object="${brand}">
                                                    <option th:value="*{id}" th:text="*{name}"></option>
                                                </th:block>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="form-group row">
                                        <strong class="col-sm-2 col-form-label text-right">
                                            Loại sản phẩm
                                        </strong>
                                        <div class="col-sm-10">
                                            <select class="select2 form-control custom-select" name="idCategory"
                                                    id="idCategory" style="width: 100%; height:36px;">
                                                <th:block th:each="category:${lstCategories}" th:object="${category}">
                                                    <option th:value="*{id}" th:text="*{name}"></option>
                                                </th:block>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="form-group row">
                                        <strong class="col-sm-2 col-form-label text-right">
                                            Giá bán ra
                                        </strong>
                                        <div class="col-sm-10">
                                            <input class="form-control" type="text" placeholder="Nhập giá bán ra"
                                                   name="price" maxlength="32">
                                        </div>
                                    </div>
                                    <div class="form-group row">
                                        <strong class="col-sm-2 col-form-label text-right">
                                            Giá giảm
                                        </strong>
                                        <div class="col-sm-10">
                                            <input class="form-control" type="text" placeholder="Nhập giá giảm"
                                                   name="priceSale" maxlength="32">
                                        </div>
                                    </div>
                                    <div class="form-group row">
                                        <strong class="col-sm-2 col-form-label text-right">
                                            Số lượng
                                        </strong>
                                        <div class="col-sm-10">
                                            <input class="form-control" type="text" placeholder="Nhập số lượng"
                                                   name="quantity" maxlength="32">
                                        </div>
                                    </div>
                                    <div class="form-group row">
                                        <strong class="col-sm-2 col-form-label text-right">
                                            Màu sắc
                                        </strong>
                                        <div class="col-sm-10">
                                            <input class="form-control" type="text" placeholder="Nhập màu sắc"
                                                   name="color" maxlength="32">
                                        </div>
                                    </div>
                                    <div class="form-group row">
                                        <strong class="col-sm-2 col-form-label text-right">
                                            Loại chi tiết
                                        </strong>
                                        <div class="col-sm-10">
                                            <input class="form-control" type="text" placeholder="Nhập loại chi tiết"
                                                   name="categoryDetails" maxlength="32">
                                        </div>
                                    </div>
                                    <div class="form-group row">
                                        <strong class="col-sm-2 col-form-label text-right">
                                            Vị trí
                                        </strong>
                                        <div class="col-sm-10">
                                            <input class="form-control" type="text"
                                                   placeholder="Nhập vị trí đặt sản phẩm"
                                                   name="location" maxlength="32">
                                        </div>
                                    </div>
                                    <div class="form-group row">
                                        <strong class="col-sm-2 col-form-label text-right">
                                            Mô tả
                                        </strong>
                                        <div class="col-sm-10">
                                            <textarea class="form-control" name="description" maxlength="255" rows="3"
                                                      placeholder="Nhập mô tả"></textarea>
                                        </div>
                                    </div>
                                    <div class="form-group row">
                                        <strong class="col-sm-2 col-form-label text-right">
                                            Hướng dẫn sử dụng
                                        </strong>
                                        <div class="col-sm-10">
                                            <input type="file" id="input-file-now-custom-2" name="pathUserManual"
                                                   class="file-user-manual dropify"
                                                   accept="application/msword, application/vnd.ms-excel, application/vnd.ms-powerpoint, text/plain, application/pdf"
                                                   onchange="onChangeFile(this)" data-oldfile="" data-height="200">
                                        </div>
                                    </div>
                                </form>
                            </div>
                            <div id="step-2" class="">
                                <form id="form-images-product" class="row">
                                </form>
                            </div>
                        </div>
                        <!--end /div-->
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary waves-effect" data-dismiss="modal">Huỷ bỏ
                        </button>
                        <button type="button" onclick="saveProduct()" class="btn btn-primary waves-effect waves-light">
                            Lưu lại
                        </button>
                    </div>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div>
    <!-- /.modal -->
</div>
<th:block layout:fragment="script-admin">
    <script>

        let objFileImage = {
            data: [],
            nameFile: [],
        }

        async function onChangeImage(e) {
            if (!checkImage(e.files[0].name, 'File ')) return;
            let index = e.dataset.index
            // objFile.targetFile = e
            // objFileImage.targetFile[index] = e
            objFileImage.nameFile[index] = getNameTime() + e.files[0].name
            let data = await toBase64(e.files[0])
            objFileImage.data[index] = data
        }

        for (let i = 0; i < 12; i++) {
            $('#form-images-product').append('<div class="col-lg-4">' +
                '<input type="file" class="dropify" data-height="150" data-index="' + i + '" accept="image/png, image/gif, image/jpeg" onchange="onChangeImage(this)">' +
                '</div>').html()
        }

        $('#name').change(function (e) {
            $('#path').val(strToPath($('#name').val()))
        });

        $('#path').change(function (e) {
            let pathUrl = strToPath($('#path').val())
            $('#path').val(pathUrl)
        })

        let objFile = {
            data: null,
            nameFile: null,
        }

        async function onChangeFile(e) {
            objFile.nameFile = getNameTime() + e.files[0].name
            let data = await toBase64(e.files[0])
            objFile.data = data
        }

        async function saveProduct() {
            let form = $("#form-input-product").serializeArray()
            let obj = {};
            for (let i = 0; i < form.length; i++) {
                let name = form[i].name;
                obj[name] = form[i].value;
            }
            console.log(obj)
            swal('Đang lưu...', 'Vui lòng đợi', 'success')
            if (objFile.data !== null && objFile.data !== undefined) {
                let data = objFile.data + '';
                console.log(data)
                let base = data.substring(data.indexOf(",") + 1, data.length)
                await fetch('https://api.github.com/repos/ngocnqph12806/Repo_File/contents/' + objFile.nameFile, {
                    method: 'PUT',
                    headers: {
                        "Authorization": "Bearer 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",
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        "message": "uploading a file in date: " + getNameTime(),
                        "content": base
                    }),
                })
                    .then(response => response.json())
                    .then(out => {
                        console.log("up thành công");
                    })
                    .catch((error) => {
                        console.error('Error:', error);
                    });
                objFile.data = null
            }
            for (let i = 0; i < objFileImage.nameFile.length; i++) {
                if (objFileImage.nameFile[i] !== null
                    && objFileImage.nameFile[i] !== undefined
                    && objFileImage.nameFile[i] !== '') {
                    if (!checkImage(objFileImage.nameFile[i], 'Hình ảnh số ' + (i + 1))) {
                        objFileImage.nameFile[i] = null;
                        return;
                    } else if (objFileImage.data[i] !== null && objFileImage.data[i] !== undefined
                        && objFileImage.nameFile[i] !== null && objFileImage.nameFile[i] !== undefined) {
                        let data = objFileImage.data[i] + '';
                        console.log(data)
                        let base = data.substring(data.indexOf(",") + 1, data.length)
                        await fetch('https://api.github.com/repos/ngocnqph12806/Repo_File/contents/' + objFileImage.nameFile[i], {
                            method: 'PUT',
                            headers: {
                                "Authorization": "Bearer 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",
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                "message": "uploading a file in date: " + getNameTime(),
                                "content": base
                            }),
                        })
                            .then(response => response.json())
                            .then(out => {
                                console.log("up thành công");
                            })
                            .catch((error) => {
                                console.error('Error:', error);
                            });
                        objFileImage.data[i] = null;
                    }
                }
            }
            if (!checkFileDoc(objFile.nameFile, 'File hướng dẫn sử dụng')) {
                return
            } else {
                obj['pathUserManual'] = objFile.nameFile
            }
            obj.images = objFileImage.nameFile
            console.log(obj)
            if (obj.id !== null && obj.id !== undefined && obj.id !== '') {
                saveWithAPI(JSON.stringify(obj), '/api/product' + obj.id, 'PUT')
            } else {
                saveWithAPI(JSON.stringify(obj), '/api/product', 'POST')
            }
        }

        async function saveFile() {
            if (objFile.targetFile !== null && objFile.targetFile !== undefined) {
                await writeFileGitHub(objFile.targetFile, objFile.nameFile)
                objFile.targetFile = null
            }
            for (let i = 0; i < objFileImage.nameFile.length; i++) {
                if (objFileImage.nameFile[i] !== null
                    && objFileImage.nameFile[i] !== undefined
                    && objFileImage.nameFile[i] !== '') {
                    if (!checkImage(objFileImage.nameFile[i], 'Hình ảnh số ' + (i + 1))) {
                        objFileImage.nameFile[i] = null;
                        return false;
                    } else if (objFileImage.targetFile[i] !== null && objFileImage.targetFile[i] !== undefined
                        && objFileImage.nameFile[i] !== null && objFileImage.nameFile[i] !== undefined) {
                        await writeFileGitHub(objFileImage.targetFile[i], objFileImage.nameFile[i])
                        objFileImage.nameFile[i] = null;
                    }
                }
            }
            return true;
        }

        function getProduct(e) {
            $.ajax({
                url: '/api/product/' + e.dataset.id + '?modal',
                type: 'GET',
                contentType: 'application/json',
                success: function (response) {
                    appendFormdata('form-input-product', response.data, objFile)
                }
            });
        }

        function changeStatus(e) {
            let data = e.dataset.methodData;
            let id = e.dataset.id
            if (e.dataset.method === 'status') {
                saveWithAPI(JSON.stringify({'status': data}), '/api/products', 'PUT')
            }
        }
    </script>
    <script src="/web-admin/js/daterangepicker.js"></script>
    <script src="/web-admin/js/tempusdominus-bootstrap-4.js"></script>
    <script src="/web-admin/js/bootstrap-material-datetimepicker.js"></script>
    <script src="/web-admin/js/jquery-clockpicker.min.js"></script>
    <script src="/web-admin/js/jquery-asColor.js"></script>
    <script src="/web-admin/js/jquery-asGradient.js"></script>
    <script src="/web-admin/js/jquery-asColorPicker.min.js"></script>
    <script src="/web-admin/js/select2.min.js"></script>
    <script src="/web-admin/js/bootstrap-colorpicker.min.js"></script>
    <script src="/web-admin/js/bootstrap-datepicker.min.js"></script>
    <script th:src="@{/web-admin/js/bootstrap-maxlength.min.js}"></script>
    <script th:src="@{/web-admin/js/jquery.bootstrap-touchspin.min.js}"></script>
    <script th:src="@{/web-admin/js/jquery.clock-img.init.js}"></script>
    <script th:src="@{/web-admin/js/jquery.forms-advanced.js}"></script>
    <!--    UPLOAD-->
    <script src="/web-admin/js/dropify.min.js"></script>
    <script src="/web-admin/js/jquery.form-upload.init.js"></script>

    <script src="/web-admin/js/jquery.repeater.min.js"></script>
    <script src="/web-admin/js/jquery.smartWizard.min.js"></script>
    <script src="/web-admin/js/jquery.form-wizard.init.js"></script>
</th:block>
<th:block layout:fragment="css-admin">
    <link th:href="@{/web-admin/css/select2.min.css}" rel="stylesheet" type="text/css">
    <!--    UPLOAD-->
    <link href="/web-admin/css/dropify.min.css" type="text/css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="/web-admin/rating.css">


    <link href="/web-admin/css/smart_wizard.css"
          rel="stylesheet" type="text/css">
    <link href="/web-admin/css/smart_wizard_theme_arrows.css"
          rel="stylesheet" type="text/css">
    <link href="/web-admin/css/smart_wizard_theme_circles.css"
          rel="stylesheet" type="text/css">
</th:block>
</body>
</html>