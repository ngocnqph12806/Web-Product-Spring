<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="/layout/admin/index"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity3">
<head>
    <th:block th:if="${isStaff}">
        <title layout:fragment="title">Dasboard - Quản lý nhân viên</title>
    </th:block>
    <th:block th:unless="${isStaff}">
        <title layout:fragment="title">Dasboard - Quản lý khách hàng</title>
    </th:block>
    <!--    <title th:unless="${isStaff}" layout:fragment="title">Dasboard - Quản lý khách hàng</title>-->
</head>
<body>
<div layout:fragment="content-admin">
    <div id="data-user"></div>
</div>

<th:block layout:fragment="script-admin">
    <th:block th:if="${isStaff}">
        <script>
            $(document).ready(function () {
                loadData('admin', 0, 5)
            })

            function clickPage(e) {
                let page = e.dataset.index
                loadData('admin', page, 5)
            }
        </script>
    </th:block>
    <th:block th:unless="${isStaff}">
        <script>
            $(document).ready(function () {
                loadData('user', 0, 5)
            })

            function clickPage(e) {
                let page = e.dataset.index
                loadData('user', page, 5)
            }
        </script>
    </th:block>
    <script>

        function loadData(type_user, page, size) {

            $.ajax({
                url: '/admin/staff/load?_p=' + page + '&_s=' + size + '&_type=' + type_user,
                type: 'GET',
                contentType: 'application/json',
                beforeSend: function (xhr) {
                    xhr.setRequestHeader("Authorization", "Bearer " + getSession('access_token'));
                },
                success: function (response) {
                    $('#data-user').html(response)
                },
                error: function (e) {
                    console.log('Lỗi lấy dữ liệu data')
                }
            });
        }

        var objFileAvatar = {
            targetFileAvatar: null,
            nameFile: null,
        }

        function onChangeFileAvatar(e) {
            objFileAvatar.targetFileAvatar = e
            objFileAvatar.nameFile = getNameTime() + e.files[0].name
        }

        function saveStaff() {
            let data = JSON.parse(JSON.stringify($("#form-input-staff").serializeArray()))
            let obj = {};
            for (let i = 0; i < data.length; i++) {
                let name = data[i].name;
                let value = data[i].value;
                // họ tên không chứa số
                if (name === 'fullName' && !checkRealName(value)) return;
                if (name === 'dateOfBirth') {
                    if (check18AgesAdmin(value)) {
                        value = value.substring(value.lastIndexOf('/') + 1) + '-' + value.substring(0, value.lastIndexOf('/')).replaceAll('/', '-');
                    } else {
                        return;
                    }
                }
                if (name === 'userName' && !checkUserName(value)) return;
                if (name === 'password' && !checkPassword(value)) return;
                if (name === 'email' && !checkEmail(value)) return;
                if (name === 'phoneNumber' && !checkPhoneNumber(value)) return;
                if (name === 'address' && !checkAddress(value)) return;
                obj[name] = value;
            }
            let role = $('#role').val();
            console.log(role)
            if (role === null || role === undefined || role === '') {
                swal('Lỗi', 'Chưa chọn chức vụ', 'warning');
                return;
            } else {
                obj['role'] = role
            }
            // if (objFileAvatar.nameFile === null || objFileAvatar.nameFile === undefined || objFileAvatar.nameFile === '') {
            if (objFileAvatar.targetFileAvatar !== null && objFileAvatar.targetFileAvatar !== undefined) {
                writeFileGitHub(objFileAvatar.targetFileAvatar, objFileAvatar.nameFile)
                objFileAvatar.targetFileAvatar = null
            }
            // }
            // avatar đúng định dạng hình ảnh
            if (!checkImage(objFileAvatar.nameFile, 'Ảnh đại diện')) {
                return
            } else {
                obj['avatar'] = objFileAvatar.nameFile
            }
            console.log(obj)
            setTimeout(function () {
                console.log(obj.id)
                if (obj.id !== null && obj.id !== undefined && obj.id !== '') {
                    saveWithAPI(JSON.stringify(obj), '/api/users' + obj.id, 'PUT')
                } else {
                    saveWithAPI(JSON.stringify(obj), '/api/users', 'POST')
                }
            }, 10)
        }

        function getStaff(e) {
            $.ajax({
                url: '/api/users/' + e.dataset.id + '?modal',
                type: 'GET',
                contentType: 'application/json',
                beforeSend: function (xhr) {
                    xhr.setRequestHeader("Authorization", "Bearer " + getSession('access_token'));
                },
                success: function (response) {
                    appendFormdata('form-input-staff', response.data, objFileAvatar)
                }
            });
        }

        function changeStaff(e) {
            let method = e.dataset.method;
            let data = e.dataset.methodData;
            let id = e.dataset.id;
            console.log(id)
            $.ajax({
                url: '/api/users/' + id,
                type: 'GET',
                contentType: 'application/json',
                beforeSend: function (xhr) {
                    xhr.setRequestHeader("Authorization", "Bearer " + getSession('access_token'));
                },
                success: function (response) {
                    if (method === 'status') {
                        let obj = response.data;
                        obj.status = data
                        saveWithAPI(JSON.stringify(obj), '/api/users' + obj.id, 'PUT')
                    } else if (method === 'block') {
                        let obj = response.data;
                        obj.block = data
                        saveWithAPI(JSON.stringify(obj), '/api/users' + obj.id, 'PUT')
                    } else {
                        swal('Hmmm!', 'Đừng sửa code...', 'warning')
                    }
                },
                error: function (response) {
                    swal('Thất bại', response.responseJSON.message, 'error')
                }
            });
        }

    </script>
    <script src="/web-admin/js/daterangepicker.js"></script>
    <script src="/web-admin/js/tempusdominus-bootstrap-4.js"></script>
    <script src="/web-admin/js/bootstrap-material-datetimepicker.js"></script>
    <script src="/web-admin/js/jquery-clockpicker.min.js"></script>
    <script src="/web-admin/js/jquery-asColor.js"></script>
    <script src="/web-admin/js/jquery-asGradient.js"></script>
    <script src="/web-admin/js/jquery-asColorPicker.min.js"></script>
    <script src="/web-admin/js/select2.min.js"></script>
    <script src="/web-admin/js/bootstrap-colorpicker.min.js"></script>
    <script src="/web-admin/js/bootstrap-datepicker.min.js"></script>
    <script th:src="@{/web-admin/js/bootstrap-maxlength.min.js}"></script>
    <script th:src="@{/web-admin/js/jquery.bootstrap-touchspin.min.js}"></script>
    <script th:src="@{/web-admin/js/jquery.clock-img.init.js}"></script>
    <script th:src="@{/web-admin/js/jquery.forms-advanced.js}"></script>

    <!--    UPLOAD-->
    <script src="/web-admin/js/dropify.min.js"></script>
    <script src="/web-admin/js/jquery.form-upload.init.js"></script>
</th:block>
<th:block layout:fragment="css-admin">
    <!--    DATE-->
    <link th:href="@{/web-admin/css/daterangepicker.css}" rel="stylesheet">
    <link th:href="@{/web-admin/css/tempusdominus-bootstrap.css}" rel="stylesheet" type="text/css">
    <link th:href="@{/web-admin/css/bootstrap-material-datetimepicker.css}" rel="stylesheet" type="text/css">
    <link th:href="@{/web-admin/css/jquery-clockpicker.min.css}" rel="stylesheet" type="text/css">
    <link th:href="@{/web-admin/css/asColorPicker.min.css}" rel="stylesheet" type="text/css">
    <link th:href="@{/web-admin/css/select2.min.css}" rel="stylesheet" type="text/css">
    <link th:href="@{/web-admin/css/bootstrap-colorpicker.min.css}" rel="stylesheet" type="text/css">
    <link th:href="@{/web-admin/css/bootstrap-datepicker.min.css}" rel="stylesheet" type="text/css">
    <link th:href="@{/web-admin/css/jquery.bootstrap-touchspin.min.css}" rel="stylesheet" type="text/css">
    <!-- App css -->

    <!--    UPLOAD-->
    <link href="/web-admin/css/dropify.min.css" type="text/css" rel="stylesheet">
</th:block>
</body>
</html>