<div class="container card-body" xmlns:th="http://www.thymeleaf.org">
    <div id="smart_wizard" th:object="${product}">
        <ul>
            <li><a href="#step-1">Nhập<br><small>Nhập thông tin sản phẩm</small></a></li>
            <li><a href="#step-2">Mô tả<br><small>Mô tả chi tiết sản phẩm</small></a></li>
            <li><a href="#step-3">Tải file<br><small>Tải lên file hướng dẫn xử dụng</small></a></li>
            <li><a href="#step-4">Tải ảnh<br><small>Tải lên ảnh sản phẩm</small></a></li>
        </ul>
        <div class="p-3 sw-default-content mb-3">
            <div id="step-1" class="">
                <form id="form-input-product">
                    <input type="hidden" name="id" th:value="*{id}"/>
                    <div class="form-group row">
                        <strong class="col-sm-2 col-form-label text-right">
                            Tên sản phẩm
                        </strong>
                        <div class="col-sm-10">
                            <input class="form-control" type="text" placeholder="Nhập tên sản phẩm"
                                   name="name" maxlength="50" id="name-product" th:value="*{name}"
                                   onchange="changeNameProductAndChangePathProduct()">
                        </div>
                    </div>
                    <div class="form-group row">
                        <strong class="col-sm-2 col-form-label text-right">
                            Đường dẫn
                        </strong>
                        <div class="col-sm-10">
                            <input class="form-control" type="text" placeholder="Nhập đường dẫn"
                                   name="path" maxlength="32" id="path-product" th:value="*{path}"
                                   onchange="changePathUrlProduct()">
                        </div>
                    </div>
                    <div class="form-group row">
                        <strong class="col-sm-2 col-form-label text-right">
                            Thương hiệu
                        </strong>
                        <div class="col-sm-10">
                            <select class="select2 form-control custom-select" name="idBrand"
                                    id="idBrand" style="width: 100%; height:36px;">
                                <th:block th:each="brand:${lstBrand}" th:object="${brand}">
                                    <option th:selected="${product.idBrand == brand.id}"
                                            th:value="*{id}" th:text="*{name}"></option>
                                </th:block>
                            </select>
                        </div>
                    </div>
                    <div class="form-group row">
                        <strong class="col-sm-2 col-form-label text-right">
                            Loại sản phẩm
                        </strong>
                        <div class="col-sm-10">
                            <select class="select2 form-control custom-select" name="idCategory"
                                    id="idCategory" style="width: 100%; height:36px;">
                                <th:block th:each="category:${lstCategory}" th:object="${category}">
                                    <option th:selected="${product.idCategory == category.id}"
                                            th:value="*{id}" th:text="*{name}"></option>
                                </th:block>
                            </select>
                        </div>
                    </div>
                    <div class="form-group row">
                        <strong class="col-sm-2 col-form-label text-right">
                            Giá bán ra
                        </strong>
                        <div class="col-sm-10">
                            <input class="form-control" type="text" placeholder="Nhập giá bán ra"
                                   th:value="*{price}" name="price" maxlength="32">
                        </div>
                    </div>
                    <div class="form-group row">
                        <strong class="col-sm-2 col-form-label text-right">
                            Giá giảm
                        </strong>
                        <div class="col-sm-10">
                            <input class="form-control" type="text" placeholder="Nhập giá giảm"
                                   th:value="*{priceSale}" name="priceSale" maxlength="32">
                        </div>
                    </div>
                    <div class="form-group row">
                        <strong class="col-sm-2 col-form-label text-right">
                            Màu sắc
                        </strong>
                        <div class="col-sm-10">
                            <input class="form-control" type="text" placeholder="Nhập màu sắc"
                                   th:value="*{color}" name="color" maxlength="32">
                        </div>
                    </div>
                    <div class="form-group row">
                        <strong class="col-sm-2 col-form-label text-right">
                            Loại chi tiết
                        </strong>
                        <div class="col-sm-10">
                            <input class="form-control" type="text" placeholder="Nhập loại chi tiết"
                                   th:value="*{categoryDetails}" name="categoryDetails" maxlength="32">
                        </div>
                    </div>
                    <div class="form-group row">
                        <strong class="col-sm-2 col-form-label text-right">
                            Vị trí
                        </strong>
                        <div class="col-sm-10">
                            <input class="form-control" type="text" th:value="*{location}"
                                   placeholder="Nhập vị trí đặt sản phẩm"
                                   name="location" maxlength="32">
                        </div>
                    </div>
                </form>
            </div>
            <div id="step-2" class="">
                <form id="form-description-product" class="row">
                    <div class="form-group row">
                    <textarea class="form-control" name="description" minlength="255" rows="3"
                              id="description" placeholder="Nhập mô tả" th:data-text="*{description}"></textarea>
                    </div>
                </form>
            </div>
            <div id="step-3" class="">
                <form id="form-pathUserManual-product" class="row">
                    <input type="file" id="input-file-now-custom-2" name="pathUserManual"
                           class="file-user-manual dropify"
                           accept="application/msword, application/vnd.ms-excel, application/vnd.ms-powerpoint, text/plain, application/pdf"
                           onchange="onChangeFile(this)" th:data-oldfile="*{pathUserManual}" data-data
                           data-height="200">
                </form>
            </div>
            <div id="step-4" class="">
                <form id="form-images-product" class="row">

                </form>
            </div>
        </div>
        <!--end /div-->
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary waves-effect" onclick="openProduct()">Huỷ bỏ
        </button>
        <button type="button" onclick="saveProduct()" class="btn btn-primary waves-effect waves-light">
            Lưu lại
        </button>
    </div>
</div>

<script th:src="@{/js/daterangepicker.js}"></script>
<script th:src="@{/js/tempusdominus-bootstrap-4.js}"></script>
<script th:src="@{/js/bootstrap-material-datetimepicker.js}"></script>
<script th:src="@{/js/jquery-clockpicker.min.js}"></script>
<script th:src="@{/js/jquery-asColor.js}"></script>
<script th:src="@{/js/jquery-asGradient.js}"></script>
<script th:src="@{/js/jquery-asColorPicker.min.js}"></script>
<script th:src="@{/js/select2.min.js}"></script>
<script th:src="@{/js/bootstrap-colorpicker.min.js}"></script>
<script th:src="@{/js/bootstrap-datepicker.min.js}"></script>
<script th:src="@{/js/bootstrap-maxlength.min.js}"></script>
<script th:src="@{/js/jquery.bootstrap-touchspin.min.js}"></script>
<script th:src="@{/js/jquery.clock-img.init.js}"></script>
<script th:src="@{/js/jquery.forms-advanced.js}"></script>
<!--    UPLOAD-->
<script th:src="@{/js/dropify.min.js}"></script>
<script th:src="@{/js/jquery.form-upload.init.js}"></script>

<script th:src="@{/js/jquery.repeater.min.js}"></script>
<script th:src="@{/js/jquery.smartWizard.min.js}"></script>
<script th:src="@{/js/jquery.form-wizard.init.js}"></script>
<script th:src="@{/ckeditor/ckeditor.js}"></script>

<script>

    $(document).ready(function () {
        CKEDITOR.replace('description')
        let description = $('#description')[0]
        CKEDITOR.instances.description.setData(description.dataset.text);
        description.dataset.text = ''
    })

    for (let i = 0; i < 9; i++) {
        $('#form-images-product').append('<div class="col-lg-4">' +
            '<input type="file" class="dropify input-file-image-product" data-height="150" data-oldfile="" data-data="" accept="image/png, image/gif, image/jpeg" onchange="onChangeImage(this)">' +
            '</div>').html()
    }

    async function onChangeImage(e) {
        if (!checkImage(e.files[0].name, 'File ')) return;
        let data = await toBase64(e.files[0])
        e.dataset.data = data
        e.dataset.oldfile = getNameTime() + e.files[0].name
    }

    function changeNameProductAndChangePathProduct() {
        $('#path-product').val(strToPath($('#name-product').val()))
    }

    function changePathUrlProduct() {
        let pathUrl = strToPath($('#path-product').val())
        $('#path-product').val(pathUrl)
    }

    async function onChangeFile(e) {
        let data = await toBase64(e.files[0])
        e.dataset.data = data
        e.dataset.oldfile = getNameTime() + e.files[0].name
    }

    async function saveProduct() {
        console.log(document.getElementById('input-file-now-custom-2').dataset.oldfile)
        let form = $("#form-input-product").serializeArray()
        let obj = {};
        for (let i = 0; i < form.length; i++) {
            let name = form[i].name;
            let value = form[i].value;
            if(name === 'name' && !checkName(value, 'Tên sản phẩm')) return;
            if(name === 'path' && !checkPath(value, 'Đừng dẫn sản phẩm')) return;
            if(name === 'idBrand'){
                if(value === null || value === undefined || value === ''){
                    swal("Lỗi", "Vui lòng chọn thương hiệu sản phẩm", "error");
                    return;
                }
            }
            if(name === 'idCategory'){
                if(value === null || value === undefined || value === ''){
                    swal("Lỗi", "Vui lòng chọn loại sản phẩm", "error");
                    return;
                }
            }
            if(name === 'price' && !checkQuantity(value, 'Giá sản phẩm')) return;
            if(name === 'priceSale' && !checkQuantity(value, 'Giá giảm của sản phẩm')) return;
            if(name === 'color' && !checkColor(value, 'Màu sắc của sản phẩm')) return;
            if(name === 'categoryDetails' && !checkName(value, 'Chi tiết loại')) return;
            if(name === 'location' && !checkName(value, 'Vị trí')) return;
            obj[name] = value;
        }
        let description = CKEDITOR.instances.description.getData();
        if(!checkDescriptionProduct(description)) return;
        obj.description = description
        let fileUseManualProduct = $('#input-file-now-custom-2')[0]
        if (!checkFileDoc(fileUseManualProduct.dataset.oldfile, 'File hướng dẫn sử dụng')) {
            return
        } else {
            obj['pathUserManual'] = fileUseManualProduct.dataset.oldfile
        }
        let arrFileImageProduct = $('.input-file-image-product')
        let arrNameFileImageProduct = []
        console.log(arrFileImageProduct)
        for (let i = 0; i < arrFileImageProduct.length; i++) {
            if (arrFileImageProduct[i].dataset.oldfile !== null
                && arrFileImageProduct[i].dataset.oldfile !== undefined
                && arrFileImageProduct[i].dataset.oldfile !== '') {
                if (!checkImage(arrFileImageProduct[i].dataset.oldfile, 'Hình ảnh số ' + (i + 1))) {
                    arrFileImageProduct[i].dataset.oldfile = null;
                    return;
                } else {
                    arrNameFileImageProduct.push(arrFileImageProduct[i].dataset.oldfile)
                }
            }
        }
        // if(arrNameFileImageProduct.length <= 0){
        //     swal("Lỗi", "Vui lòng chọn hình sản phẩm", "error")
        //     return;
        // }
        obj.images = arrNameFileImageProduct
        swal('Đang lưu...', 'Vui lòng đợi', 'success')
        if (fileUseManualProduct.dataset.data !== null && fileUseManualProduct.dataset.data !== undefined) {
            let data = fileUseManualProduct.dataset.data + '';
            let base = data.substring(data.indexOf(",") + 1, data.length)
            await fetch('https://api.github.com/repos/ngocnqph12806/Repo_File/contents/' + fileUseManualProduct.dataset.oldfile, {
                method: 'PUT',
                headers: {
                    "Authorization": "Bearer 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",
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    "message": "uploading a file in date: " + getNameTime(),
                    "content": base
                }),
            })
                .then(response => response.json())
                .then(out => {
                    console.log("up thành công");
                })
                .catch((error) => {
                    console.error('Error:', error);
                });
            fileUseManualProduct.dataset.data = null
        }
        for (let i = 0; i < arrFileImageProduct.length; i++) {
            if (arrFileImageProduct[i].dataset.oldfile !== null
                && arrFileImageProduct[i].dataset.oldfile !== undefined
                && arrFileImageProduct[i].dataset.oldfile !== '') {
                if (!checkImage(arrFileImageProduct[i].dataset.oldfile, 'Hình ảnh số ' + (i + 1))) {
                    arrFileImageProduct[i].dataset.oldfile = null;
                    return;
                } else if (arrFileImageProduct[i].dataset.data !== null && arrFileImageProduct[i].dataset.data !== undefined
                    && arrFileImageProduct[i].dataset.oldfile !== null && arrFileImageProduct[i].dataset.oldfile !== undefined) {
                    let data = arrFileImageProduct[i].dataset.data + '';
                    let base = data.substring(data.indexOf(",") + 1, data.length)
                    await fetch('https://api.github.com/repos/ngocnqph12806/Repo_File/contents/' + arrFileImageProduct[i].dataset.oldfile, {
                        method: 'PUT',
                        headers: {
                            "Authorization": "Bearer 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",
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            "message": "uploading a file in date: " + getNameTime(),
                            "content": base
                        }),
                    }).then(response => response.json())
                        .then(out => {
                            console.log("up thành công");
                        })
                        .catch((error) => {
                            console.error('Error:', error);
                        });
                    arrFileImageProduct[i].dataset.data = null;
                }
            }
        }
        if (obj.id !== null && obj.id !== undefined && obj.id !== '') {
            saveWithAPI(JSON.stringify(obj), '/api/product/' + obj.id, 'PUT', '/admin/load/product', 0, 5)
        } else {
            saveWithAPI(JSON.stringify(obj), '/api/product', 'POST', '/admin/load/product', 0, 5)
        }
    }

</script>